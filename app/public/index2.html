<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Simple markers</title>
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0;
        padding: 0;
      }

    </style>
  <!-- jQuery API -->
   <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>

  <!-- Bootstrap core CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="customtheme.css" rel="stylesheet">

    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>

        
    <script>
    function hideInfo () {
      $('#infoBox').hide();
     } 

      var parsed;
       var xhr = new XMLHttpRequest();
       var map; 
      function getLocs() {

              // var xhr = new XMLHttpRequest();

              console.log("Inside serverRequest");

              xhr.open("GET", "http://localhost:3000/locations", true);
              // xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
              xhr.onreadystatechange = parseData;

              // locs = $.get("http://localhost:3000/locations", 
              //     function(data){
              //         console.log("about to send data to parse");
              //         parsed = parseData(data)}, "json" );
              //         parsed;

              xhr.send();
      }

      function parseData() {
        console.log("Inside parseData");

        var stylesArray = [
  {
    "featureType": "poi",
    "elementType": "labels",
    "stylers": [
      { "visibility": "off" }
    ]
  },{
    "featureType": "landscape",
    "stylers": [
      { "visibility": "simplified" },
      { "color": "#afac9c" },
      { "lightness": 85 }
    ]
  }  ];


    

        // var iconBase = 'https://maps.google.com/mapfiles/kml/shapes/';
        var iconBase = '';
        var icons = {
            food: {
              icon: iconBase + 'images/food.png'
            },
            drink : {
              icon: iconBase + 'images/drink.png'
            },
            hotel: {
              icon: iconBase + 'images/hotel.png'
            },
            retail: {
              icon: iconBase + 'images/retail.png'
            }
        };
      var styledMap = new google.maps.StyledMapType(stylesArray, {name: "Styled Map"});
      var cent = new google.maps.LatLng(34.076347,-118.370240);
      var mapOptions = {
          zoom: 18,
          center: cent,
          mapTypeControlOptions: {
            mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style']
          }
      } 

      var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      map.mapTypes.set('map_style', styledMap);
      map.setMapTypeId('map_style');
        // var map = new google.maps.Map(document.getElementById('map'), {
        //   zoom: 18,
        //   center: cent,
        //   mapTypeId: google.maps.MapTypeId.ROADMAP
        // });

        var infowindow = new google.maps.InfoWindow();

        var marker, i;

          if (xhr.readyState == 4 && xhr.status == 200) {
              // if(data[0] == null) {
                  // console.log("PD error1");
                 
              // } else {
                data = JSON.parse(xhr.responseText);
                  for(i = 0; i < data.length; i++ ){
                      type = data[i]['cat'];
                      marker = new google.maps.Marker({
                        position: new google.maps.LatLng(data[i]['long'], data[i]['lat']),
                        icon: icons[type].icon,
                        map: map

                      });
                      $('#listTable').append(
                        "<tr>" + 
                            '<td class="filterable-cell">' + '<h3>' + data[i]['business'] + '</h3>' + '</td>' +
                            '<td class="filterable-cell">Escort</td>' +
                            '<td class="filterable-cell">Blue</td>' +
                            '<td class="filterable-cell">2000</td>' +
                        '</tr>'
                        );

                      $('#listTable').append('</tbody>')
                   google.maps.event.addListener(marker, 'click', (function(marker, i) {
          return function() {
            infowindow.setContent(data[i]['business']);
            infowindow.open(map, marker);
            document.getElementById('info').innerHTML = ("<h1>" + data[i]['business']);
            $('#infoBox').show();
          }
        })(marker, i));
      }
                    // descrip = data[i]['description'];
                    // price = data[i]['price'];
                    // rating = data[i]['rating'];
                    // totalRatings = data[i]['total'];
                    // stars = (rating/totalRatings);
                    // $('#Dishes').append("<h3>" + foodName + ": <a href='" + yelpid + ".html'>" + restname + "</a></h3><p>" + descrip+ "</p><p>$" + price + " | Stars: "+ Math.ceil(stars) + "</p>");
                // }
            }
      }

  
    var lngs = [-118.370240,  -118.370354, -118.369599] 
    var lats = [34.076347,   34.076255,    34.076293]
    
    function initialize() 
    {

      getLocs();
    }
  
  function loop (locs){
  console.log("before readystate");
    console.log(locs);
  // for (var i = 12; i >= 0; i--) 
  // if (xhr.readyState == 4 && xhr.status == 200){
    console.log("in readystate");
    console.log(locs);
    $.each(locs, function(){
        myLatlng = new google.maps.LatLng(locs[i]['lat'],locs[i]['lng'])
        marker = new google.maps.Marker({
        position: myLatlng,
        map: map,
        title: 'Hello World!'
    });
  });


}

google.maps.event.addDomListener(window, 'load', initialize);


    function start () {
      var locs = getLocs();
      initialize();
      loop(locs);

     
    }
    </script>
  </head>
  <body>
    <div class='navbar navbar-default navbar-fixed-top'>
        <a class="navbar-brand" href="#">
                <img style="max-width:200px; margin-top: -7px;" src="images/logo-02.png" alt="">
            </a>
    </div>
    <div class='col-xs-12' id='main' style="width:100%; height:100%;">
    <div id="map-canvas" class='col-xs-8'></div>
    <div id='right' class='col-xs-4'>
        <div id='infoBox' class='col-xs-12'>
          infoBox
                      <a onclick="hideInfo()" href='#'>X  Close</a>

          <div id='info' class='col-xs-12'> 
            info
          </div>
          
        </div>

        <div id='list' class='col-xs-12'> 
          <table id='listTable' class="table table-striped">
    <thead>
    <tr>
        <th>Make</th>
        <th>Model</th>
        <th>Color</th>
        <th>Year</th>
    </tr>
    </thead>
    <tbody>
    

    
        </div>
    </div>
  </div>
</div>
  </body>

   <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    
    <script src="../../dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../../assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>